<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>test</title>
	<meta name="author" content="Derrick Oswald" />
	<!-- Date: 2013-03-27 -->
    <script type="text/javascript" src="./bencoder.js"></script>
</head>
<body>
<style>
  #read_button {
     margin-left: 25px;
  }
  #byte_content {
    margin: 5px 0;
    max-height: 500px;
    overflow-y: auto;
    overflow-x: hidden;
  }
  #bencode_content {
    margin: 5px 0;
    max-height: 500px;
    overflow-y: auto;
    overflow-x: hidden;
  }
  #byte_range { margin-top: 5px; }
</style>
<input id="files" type="file" name="file" />
<button id="read_button">Read File</button>
<div id="byte_range"></div>
<div id="byte_content"></div>
<div id="bencode_content"></div>

<script>
function readBlob (opt_startByte, opt_stopByte)
{
    var files = document.getElementById ('files').files;
    if (!files.length)
    {
        alert ('Please select a file!');
        return;
    }

    var file = files[0];
    var start = parseInt (opt_startByte) || 0;
    var stop = parseInt (opt_stopByte) || file.size - 1;

    var reader = new FileReader ();

    // If we use onloadend, we need to check the readyState.
    reader.onloadend = function (evt)
    {
        if (evt.target.readyState == FileReader.DONE)
        { // DONE == 2
            document.getElementById ('byte_range').textContent = [ 'Read bytes: ', start + 1, ' - ', stop + 1, ' of ', file.size,
                    ' byte file' ].join ('');
            var binary_torrent = decode (evt.target.result, true);
            // we need to use the binary version of the "pieces" element so that it
            // doesn't get converted to UTF-8 as required by the bencoding specification
            var string_torrent = decode (evt.target.result, false);
            string_torrent["info"]["pieces"] = binary_torrent ["info"]["pieces"];
            document.getElementById ('byte_content').innerHTML = "<pre><code>" + JSON.stringify (string_torrent, null, 4) + "</code></pre>";
            var output = encode (string_torrent);
            document.getElementById ('bencode_content').innerHTML = "<a href='data:application/octet-stream;base64," + btoa (output) + "' download='output.torrent'>Torrent File</a>";
        }
    };

    var blob = file.slice (start, stop + 1);
    reader.readAsArrayBuffer (blob);
}
  document.querySelector('#read_button').addEventListener('click', function(evt) {
    if (evt.target.tagName.toLowerCase() == 'button') {
      var startByte = evt.target.getAttribute('data-startbyte');
      var endByte = evt.target.getAttribute('data-endbyte');
      readBlob(startByte, endByte);
    }
  }, false);
</script>
</body>
</html>

